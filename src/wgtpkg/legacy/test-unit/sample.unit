{{#targets.list}}

%begin systemd-unit

# auto generated by wgtpkg-unit for {{id}} version {{version}} target {{:#target}}
%nl

[unit]
Description={{description}}
X-Name={{name.content}}
X-Name-Short={{name.short}}
X-Id={{id}}
X-Idaver={{idaver}}
X-Target-Name={{:#target}}
X-Author={{{author.content}}}
X-Author-email={{author.email}}
%nl

# Adds check to smack
ConditionSecurity=smack
%nl

# Automatic bound to required api
{{#required-api.list}}
BindsTo=afm-api-{{name}}
After=afm-api-{{name}}
{{/required-api.list}}
%nl

[Service]
SmackProcessLabel=App:{{id}}

{{#required-permission.dict}}
  {{#urn:redpesk:permission::platform:no-oom}}      OOMScoreAdjust=-500             {{/urn:redpesk:permission::platform:no-oom}}
  {{#urn:redpesk:permission::partner:real-time}}    IOSchedulingClass=realtime      {{/urn:redpesk:permission::partner:real-time}}
  {{^urn:redpesk:permission::partner:real-time}}    RestrictRealtime=on             {{/urn:redpesk:permission::partner:real-time}}
  {{#urn:redpesk:permission::public:display}}       SupplementaryGroups=display     {{/urn:redpesk:permission::public:display}}
  {{^urn:redpesk:permission::public:syscall:clock}} SystemCallFilter=~@clock        {{/urn:redpesk:permission::public:syscall:clock}}
  {{^urn:redpesk:permission::public:internet}}      RestrictAddressFamilies=AF_UNIX {{/urn:redpesk:permission::public:internet}}
{{/required-permission.dict}}
%nl

WorkingDirectory={{widget-app-data-dir}}

{{#content.type=text/html}}

%systemd-unit user

%systemd-unit service afm-appli-{{idaver}}{{^#target=main}}@{{:#target}}{{/#target=main}}

ExecStart=/usr/bin/afb-binder --port=%P --random-token \
	--rootdir={{widget-install-dir}} \
	--workdir={{{widget-app-data-dir}}} \
	--roothttp=htdocs \
	{{#required-permission.dict.urn:redpesk:permission::public:applications:read}}\
	--alias=/icons:{{widget-icons-dir}} \
	\{{/required-permission.dict.urn:redpesk:permission::public:applications:read}}
	{{#required-api}}\
	--ws-client=unix:%t/bindings/{{:#target}}
	\{{/required-api}}
	--exec /usr/bin/web-runtime http://localhost:@p/{{content.src}}?token=@t

{{/content.type=text/html}}

{{#content.type=application/vnd.redpesk.service|application/vnd.agl.service}}

%systemd-unit user
%systemd-unit service afm-api-{{:#target}}

ExecStart=/usr/bin/afb-binder \
	--rootdir={{widget-install-dir}} \
	--workdir={{{widget-app-data-dir}}} \
	--no-httpd \
	--ws-server=unix:%t/bindings/{{:#target}}

%end systemd-unit
%begin systemd-unit

# auto generated by wgtpkg-unit for {{id}} version {{version}} target {{:#target}}
#
%systemd-unit user
%systemd-unit socket afm-api-{{:#target}}


[socket]
SmackLabel=*
ListenStream=%t/bindings/{{:#target}}

{{/content.type=application/vnd.redpesk.service|application/vnd.agl.service}}

%end systemd-unit

{{/targets.list}}

