;-------------------------------------------------------------------------------
; File:
;
;    afm-unit.conf
;
; Mode:
;
;    RELEASE
;
; Role:
;
;    Configure how installation of widget produces unit files for systemd
;
; Processing and format:
;
;    1. File load
;
;           Lines beginning with ; are firstly removed
;
;    2. File instantiation
;
;           Mustache (extended) substitutions are applied using JSON
;           data deduced from config.xml file of the widget.
;
;    3. Extraction of units
;
;           Extract produced units, pack it (remove empty lines and directives)
;
; Directives:
;
;    Any directive occupy one whole line starting with %
;
;     - %nl
;
;             produce an empty line at the end
;
;     - %begin systemd-unit
;     - %end systemd-unit
;
;             delimit the produced unit
;
;     - %systemd-unit user
;     - %systemd-unit system
;
;             tells the kind of unit (user/system)
;
;     - %systemd-unit service NAME
;     - %systemd-unit socket NAME
;
;             gives the name and type of the unit
;
;     - %systemd-unit wanted-by NAME
;
;             tells to install a link to unit in the wants of NAME
;
; Setting variables:
;
;    AFM uses the feature of systemd that completely ignores options prefixed
;    with X-
;
;    Consequently, options starting with X-AFM- are recorded as public data
;    about the application and options starting with X-AFM-- are
;    recorded as private data.
;
;    Examples:
;
;        X-AFM-description={{description}}
;
;              Records the description of the unit in the field "description"
;              of both the public and private object describing the unit.
;
;        X-AFM--wgtdir={{:#metadata.install-dir}}
;
;              Records the installation directory path in the field "wgtdir"
;              of the private object only.
;
{{#required-permission.urn:redpesk:permission::partner:scope-platform}}
;-------------------------------------------------------------------------------
;----        F O R E A C H   P R O V I D E D   B I N D I N G     (PLATFORM) ----
;-------------------------------------------------------------------------------
{{#provided-binding}}
;-------------------------------------------------------------------------------
;----    T H E   S E R V I C E   O F   T H E   B I N D I N G       (USER)   ----
;-------------------------------------------------------------------------------
%begin systemd-unit

# auto generated by redpesk framework for {{:id}} version {{:version}} target {{:#target}} of {{:idaver}}

%systemd-unit system
%systemd-unit service afm-link-{{name}}@
%systemd-unit wanted-by afm-user-session@.target

[Unit]
Description=Provides binding {{name}} for user %i

BindsTo=afm-user-setup@%i.service
After=afm-user-setup@%i.service
Requires=afm-link-{{name}}.service
After=afm-link-{{name}}.service

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/bin/ln -sf {{:#metadata.root-dir}}//run/platform/apis/link/{{name}} /run/user/%i/apis/link/{{name}}

%end systemd-unit

;-------------------------------------------------------------------------------
;----    T H E   S E R V I C E   O F   T H E   B I N D I N G   (PLATFORM)   ----
;-------------------------------------------------------------------------------
%begin systemd-unit

# auto generated by redpesk framework for {{:id}} version {{:version}} target {{:#target}} of {{:idaver}}

%systemd-unit system
%systemd-unit service afm-link-{{name}}
%systemd-unit wanted-by multi-user.target

[Unit]
Description=Provides binding {{name}} for platform

Requires=afm-system-setup.service
After=afm-system-setup.service

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/bin/ln -sf {{:#metadata.root-dir}}/{{:#metadata.install-dir}}/{{value}} /run/platform/apis/link/{{name}}

%end systemd-unit

{{/provided-binding}}
;-------------------------------------------------------------------------------
{{/required-permission.urn:redpesk:permission::partner:scope-platform}}{{^required-permission.urn:redpesk:permission::partner:scope-platform}}
;-------------------------------------------------------------------------------
;----        F O R E A C H   P R O V I D E D   B I N D I N G     (USER)     ----
;-------------------------------------------------------------------------------
{{#provided-binding}}
;-------------------------------------------------------------------------------
;----        T H E   S E R V I C E   O F   T H E   B I N D I N G            ----
;-------------------------------------------------------------------------------
%begin systemd-unit

# auto generated by redpesk framework for {{:id}} version {{:version}} target {{:#target}} of {{:idaver}}

%systemd-unit system
%systemd-unit service afm-link-{{name}}@
%systemd-unit wanted-by afm-user-session@.target

[Unit]
Description=Provides binding {{name}} for user %i

BindsTo=afm-user-setup@%i.service
After=afm-user-setup@%i.service

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/bin/ln -sf {{:#metadata.root-dir}}/{{:#metadata.install-dir}}/{{value}} /run/user/%i/apis/link/{{name}}

%end systemd-unit

{{/provided-binding}}
;-------------------------------------------------------------------------------
{{/required-permission.urn:redpesk:permission::partner:scope-platform}}
;-------------------------------------------------------------------------------
;----        F O R E A C H   T A R G E T                                    ----
;-------------------------------------------------------------------------------
{{#targets}}
;-------------------------------------------------------------------------------
;-------------------------------------------------------------------------------
;----         M A I N    P A R T    O F   T H E   S E R V I C E             ----
;-------------------------------------------------------------------------------
%begin systemd-unit

# auto generated by redpesk framework for {{:id}} version {{:version}} target {{:#target}} of {{:idaver}}
%nl

%systemd-unit system
{{#required-permission.urn:redpesk:permission::partner:scope-platform}}
%systemd-unit service afm-{{#required-permission.urn:redpesk:permission::public:hidden}}service{{/required-permission.urn:redpesk:permission::public:hidden}}{{^required-permission.urn:redpesk:permission::public:hidden}}appli{{/required-permission.urn:redpesk:permission::public:hidden}}-{{:id}}--{{:#target}}
{{/required-permission.urn:redpesk:permission::partner:scope-platform}}{{^required-permission.urn:redpesk:permission::partner:scope-platform}}
%systemd-unit service afm-{{#required-permission.urn:redpesk:permission::public:hidden}}service{{/required-permission.urn:redpesk:permission::public:hidden}}{{^required-permission.urn:redpesk:permission::public:hidden}}appli{{/required-permission.urn:redpesk:permission::public:hidden}}-{{:id}}--{{:#target}}@
{{/required-permission.urn:redpesk:permission::partner:scope-platform}}

[Unit]
Description={{description}}
X-AFM-description={{description}}
X-AFM-name={{name.content}}
X-AFM-shortname={{name.short}}
X-AFM-id={{idaver}}{{^#target=main}}--{{:#target}}{{/#target=main}}
X-AFM-version={{:version}}
X-AFM-author={{author.content}}
X-AFM-author-email={{author.email}}
X-AFM-width={{width}}
X-AFM-height={{height}}
{{#icon}}
X-AFM-icon={{:#metadata.root-dir}}/{{:#metadata.install-dir}}/{{:src}}
{{/icon}}
X-AFM--ID={{:#metatarget.afid}}
{{##metadata.redpak}}
X-AFM--redpak-id={{:#metadata.redpak-id}}
{{/#metadata.redpak}}
X-AFM--rootdir={{:#metadata.root-dir}}
X-AFM--wgtdir={{:#metadata.root-dir}}/{{:#metadata.install-dir}}
X-AFM--workdir={{:#metadata.root-dir}}/{{#required-permission.urn:redpesk:permission::partner:scope-platform}}/var/scope-platform{{/required-permission.urn:redpesk:permission::partner:scope-platform}}{{^required-permission.urn:redpesk:permission::partner:scope-platform}}/home/%i/app-data{{/required-permission.urn:redpesk:permission::partner:scope-platform}}/{{:id}}
X-AFM--target-name={{:#target}}
X-AFM--content={{content.src}}
X-AFM--type={{content.type}}
X-AFM--visibility={{#content.type=application/vnd.agl.resource|application/vnd.redpesk.resource}}hidden{{/content.type=application/vnd.agl.resource|application/vnd.redpesk.resource}}{{^content.type=application/vnd.agl.resource|application/vnd.redpesk.resource}}{{#required-permission.urn:redpesk:permission::public:hidden}}hidden{{/required-permission.urn:redpesk:permission::public:hidden}}{{^required-permission.urn:redpesk:permission::public:hidden}}visible{{/required-permission.urn:redpesk:permission::public:hidden}}{{/content.type=application/vnd.agl.resource|application/vnd.redpesk.resource}}
%nl

{{#required-permission.urn:redpesk:permission::partner:scope-platform}}
X-AFM--scope=platform
After=afm-system-setup.service
{{/required-permission.urn:redpesk:permission::partner:scope-platform}}{{^required-permission.urn:redpesk:permission::partner:scope-platform}}
X-AFM--scope=user
BindsTo=afm-user-session@%i.target
After=user@%i.service
{{/required-permission.urn:redpesk:permission::partner:scope-platform}}

After=Network.target
{{#required-permission.urn:redpesk:permission::public:network}}
Wants=network.target
{{/required-permission.urn:redpesk:permission::public:network}}
{{#required-permission.urn:redpesk:permission::public:bluetooth}}
Wants=bluetooth.target
After=bluetooth.target
{{/required-permission.urn:redpesk:permission::public:bluetooth}}

{{#required-permission.urn:redpesk:permission::public:display}}
BindsTo=weston@display.service
After=weston@display.service
{{/required-permission.urn:redpesk:permission::public:display}}

# Adds check to smack or selinux
ConditionSecurity=|smack
ConditionSecurity=|selinux
%nl

# Automatic bound to required api
{{#required-binding}}
{{#value=extern}}
Requires=afm-link-{{name}}{{^required-permission.urn:redpesk:permission::partner:scope-platform}}@%i{{/required-permission.urn:redpesk:permission::partner:scope-platform}}.service
After=afm-link-{{name}}{{^required-permission.urn:redpesk:permission::partner:scope-platform}}@%i{{/required-permission.urn:redpesk:permission::partner:scope-platform}}.service
{{/value=extern}}
{{/required-binding}}

{{#required-api}}
{{#value=auto|ws}}
Requires=afm-api-{{name}}{{^required-permission.urn:redpesk:permission::partner:scope-platform}}@%i{{/required-permission.urn:redpesk:permission::partner:scope-platform}}.service
After=afm-api-{{name}}{{^required-permission.urn:redpesk:permission::partner:scope-platform}}@%i{{/required-permission.urn:redpesk:permission::partner:scope-platform}}.service
{{/value=auto|ws}}
{{/required-api}}

{{#provided-api}}
{{#value=ws|auto}}
Requires=afm-api-{{name}}{{^required-permission.urn:redpesk:permission::partner:scope-platform}}@%i{{/required-permission.urn:redpesk:permission::partner:scope-platform}}.socket
After=afm-api-{{name}}{{^required-permission.urn:redpesk:permission::partner:scope-platform}}@%i{{/required-permission.urn:redpesk:permission::partner:scope-platform}}.socket
{{/value=ws|auto}}
{{/provided-api}}

{{#required-systemd}}
{{#mode=strict}}BindsTo{{/mode=strict}}{{^mode=strict}}{{#mode=weak}}Wants{{/mode=weak}}{{^mode=weak}}Requires{{/mode=weak}}{{/mode=strict}}={{unit}}
After={{unit}}
{{/required-systemd}}

%nl

[Service]

EnvironmentFile=-{{:#metadata.root-dir}}/CONFDIR/afm/unit.env.d/*
EnvironmentFile=-{{:#metadata.root-dir}}/CONFDIR/afm/widget.env.d/{{:id}}/*
SmackProcessLabel=App:{{:id}}
SELinuxContext=system_u:system_r:{{:id-underscore}}_t:s0
SuccessExitStatus=0 SIGKILL
UMask=0077

{{#required-permission.urn:redpesk:permission::partner:scope-platform}}
#DynamicUser=true
User=daemon
Group=nobody
Slice=platform.slice
{{/required-permission.urn:redpesk:permission::partner:scope-platform}}{{^required-permission.urn:redpesk:permission::partner:scope-platform}}
User=%i
Slice=user-%i.slice
WorkingDirectory=-{{:#metadata.root-dir}}/{{#required-permission.urn:redpesk:permission::partner:scope-platform}}/var/scope-platform{{/required-permission.urn:redpesk:permission::partner:scope-platform}}{{^required-permission.urn:redpesk:permission::partner:scope-platform}}/home/%i/app-data{{/required-permission.urn:redpesk:permission::partner:scope-platform}}/{{:id}}
Environment=DBUS_SESSION_BUS_ADDRESS=unix:path={{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}/run/user/%i/bus
{{/required-permission.urn:redpesk:permission::partner:scope-platform}}
{{#required-permission.urn:redpesk:permission::system:capability:keep-all}}
CapabilityBoundingSet=~
AmbientCapabilities=~
{{/required-permission.urn:redpesk:permission::system:capability:keep-all}}{{^required-permission.urn:redpesk:permission::system:capability:keep-all}}
CapabilityBoundingSet=
{{/required-permission.urn:redpesk:permission::system:capability:keep-all}}

{{#required-permission.urn:redpesk:permission::partner:cgroup-manager}}
Delegate=yes
{{/required-permission.urn:redpesk:permission::partner:cgroup-manager}}{{^required-permission.urn:redpesk:permission::partner:cgroup-manager}}
ExecStartPre=-{{##metadata.redpak}}/usr/bin/redwrap --redpath {{:#metadata.root-dir}} -- {{/#metadata.redpak}} /bin/mkdir -p {{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}{{#required-permission.urn:redpesk:permission::partner:scope-platform}}/var/scope-platform{{/required-permission.urn:redpesk:permission::partner:scope-platform}}{{^required-permission.urn:redpesk:permission::partner:scope-platform}}/home/%i/app-data{{/required-permission.urn:redpesk:permission::partner:scope-platform}}/{{:id}}
{{/required-permission.urn:redpesk:permission::partner:cgroup-manager}}

{{#required-permission.urn:redpesk:permission::platform:no-oom}}OOMScoreAdjust=-500{{/required-permission.urn:redpesk:permission::platform:no-oom}}
{{#required-permission.urn:redpesk:permission::partner:real-time}}IOSchedulingClass=realtime{{/required-permission.urn:redpesk:permission::partner:real-time}}
{{#required-permission.urn:redpesk:permission::partner:tty}}SupplementaryGroups=tty{{/required-permission.urn:redpesk:permission::partner:tty}}
{{#required-permission.urn:redpesk:permission::partner:dialout}}SupplementaryGroups=dialout{{/required-permission.urn:redpesk:permission::partner:dialout}}
{{#required-permission.urn:redpesk:permission::partner:video}}SupplementaryGroups=video{{/required-permission.urn:redpesk:permission::partner:video}}
{{#required-permission.urn:redpesk:permission::public:display}}SupplementaryGroups=display{{/required-permission.urn:redpesk:permission::public:display}}
{{#required-permission.urn:redpesk:permission::public:audio}}SupplementaryGroups=audio{{/required-permission.urn:redpesk:permission::public:audio}}
{{^required-permission.urn:redpesk:permission::public:syscall:clock}}SystemCallFilter=~@clock{{/required-permission.urn:redpesk:permission::public:syscall:clock}}
%nl

Environment=AFM_ID={{idaver}}{{^#target=main}}--{{:#target}}{{/#target=main}}
Environment=AFM_APP_INSTALL_DIR={{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}{{:#metadata.install-dir}}
Environment=PATH=/usr/sbin:/usr/bin:/sbin:/bin:{{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}{{:#metadata.install-dir}}/bin
Environment=LD_LIBRARY_PATH={{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}{{:#metadata.install-dir}}/lib
Environment=AFM_WORKDIR={{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}{{#required-permission.urn:redpesk:permission::partner:scope-platform}}/var/scope-platform{{/required-permission.urn:redpesk:permission::partner:scope-platform}}{{^required-permission.urn:redpesk:permission::partner:scope-platform}}/home/%i/app-data{{/required-permission.urn:redpesk:permission::partner:scope-platform}}/{{:id}}
Environment=AFM_WSAPI_DIR={{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}{{#required-permission.urn:redpesk:permission::partner:scope-platform}}{{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}/run/platform{{/required-permission.urn:redpesk:permission::partner:scope-platform}}{{^required-permission.urn:redpesk:permission::partner:scope-platform}}{{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}/run/user/%i{{/required-permission.urn:redpesk:permission::partner:scope-platform}}/apis/ws
Environment=XDG_DATA_HOME={{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}{{#required-permission.urn:redpesk:permission::partner:scope-platform}}/var/scope-platform{{/required-permission.urn:redpesk:permission::partner:scope-platform}}{{^required-permission.urn:redpesk:permission::partner:scope-platform}}/home/%i/app-data{{/required-permission.urn:redpesk:permission::partner:scope-platform}}/{{:id}}
Environment=XDG_CONFIG_HOME={{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}{{#required-permission.urn:redpesk:permission::partner:scope-platform}}/var/scope-platform{{/required-permission.urn:redpesk:permission::partner:scope-platform}}{{^required-permission.urn:redpesk:permission::partner:scope-platform}}/home/%i/app-data{{/required-permission.urn:redpesk:permission::partner:scope-platform}}/{{:id}}
Environment=XDG_CACHE_HOME={{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}{{#required-permission.urn:redpesk:permission::partner:scope-platform}}/var/scope-platform{{/required-permission.urn:redpesk:permission::partner:scope-platform}}{{^required-permission.urn:redpesk:permission::partner:scope-platform}}/home/%i/app-data{{/required-permission.urn:redpesk:permission::partner:scope-platform}}/{{:id}}
Environment=XDG_RUNTIME_DIR={{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}{{#required-permission.urn:redpesk:permission::partner:scope-platform}}{{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}/run/platform{{/required-permission.urn:redpesk:permission::partner:scope-platform}}{{^required-permission.urn:redpesk:permission::partner:scope-platform}}{{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}/run/user/%i{{/required-permission.urn:redpesk:permission::partner:scope-platform}}
{{#content.type=text/html}}Environment=WAIT_FOR_HOST_SERVICE="1"{{/content.type=text/html}}



SyslogIdentifier=afbd-{{idaver}}{{^#target=main}}--{{:#target}}{{/#target=main}}
StandardInput=null
StandardOutput=journal
StandardError=journal

;-------------------------------------------------------------------------------
;----   text/html  application/vnd.agl.native  application/vnd.agl.service  ----
;----   application/vnd.redpesk.httpd                                       ----
;-------------------------------------------------------------------------------
{{#content.type=text/html|application/vnd.redpesk.native|application/vnd.agl.native|application/vnd.redpesk.service|application/vnd.agl.service|application/vnd.redpesk.httpd}}


{{^content.type=application/vnd.redpesk.service|application/vnd.agl.service}}
X-AFM--http-port={{:#metatarget.http-port}}
{{/content.type=application/vnd.redpesk.service|application/vnd.agl.service}}


Type=notify
NotifyAccess={{##metadata.redpak}}all{{/#metadata.redpak}}{{^#metadata.redpak}}main{{/#metadata.redpak}}
ExecStart={{##metadata.redpak}}/usr/bin/redwrap --redpath {{:#metadata.root-dir}} -- {{/#metadata.redpak}} \
	{{^#metadata.redpak}}/usr{{/#metadata.redpak}}/bin/afb-binder \
	--name afbd-{{idaver}}{{^#target=main}}--{{:#target}}{{/#target=main}} \
	--rootdir={{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}{{:#metadata.install-dir}} \
	--workdir={{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}{{#required-permission.urn:redpesk:permission::partner:scope-platform}}/var/scope-platform{{/required-permission.urn:redpesk:permission::partner:scope-platform}}{{^required-permission.urn:redpesk:permission::partner:scope-platform}}/home/%i/app-data{{/required-permission.urn:redpesk:permission::partner:scope-platform}}/{{:id}} \
 \
	{{#content.type=application/vnd.redpesk.service|application/vnd.agl.service}} \
		--no-httpd \
	{{/content.type=application/vnd.redpesk.service|application/vnd.agl.service}}{{^content.type=application/vnd.redpesk.service|application/vnd.agl.service}} \
		--port={{:#metatarget.http-port}} \
		--interface=tcp:{{#required-permission.urn:redpesk:permission::partner:scope-platform}}localuser---{{:#metatarget.afid}}{{/required-permission.urn:redpesk:permission::partner:scope-platform}}{{^required-permission.urn:redpesk:permission::partner:scope-platform}}localuser--{{:#metatarget.afid}}{{/required-permission.urn:redpesk:permission::partner:scope-platform}}:8080 \
		--roothttp={{#required-permission.urn:redpesk:permission::public:no-htdocs}}.{{/required-permission.urn:redpesk:permission::public:no-htdocs}}{{^required-permission.urn:redpesk:permission::public:no-htdocs}}htdocs{{/required-permission.urn:redpesk:permission::public:no-htdocs}} \
	{{/content.type=application/vnd.redpesk.service|application/vnd.agl.service}} \
 \
	{{#required-permission.urn:redpesk:permission::public:applications:read}}--alias=/icons:{{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}{{:#metadata.icons-dir}}{{/required-permission.urn:redpesk:permission::public:applications:read}} \
	{{#required-config}} \
		--config={{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}{{:#metadata.install-dir}}/{{.}} \
	{{/required-config}} \
	{{#required-api}} \
		{{#value=auto|ws}}--ws-client=unix:{{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}{{#required-permission.urn:redpesk:permission::partner:scope-platform}}{{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}/run/platform{{/required-permission.urn:redpesk:permission::partner:scope-platform}}{{^required-permission.urn:redpesk:permission::partner:scope-platform}}{{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}/run/user/%i{{/required-permission.urn:redpesk:permission::partner:scope-platform}}/apis/ws/{{name}}{{/value=auto|ws}} \
		{{#value=dbus}}--dbus-client={{name}}{{/value=dbus}} \
		{{#value=cloud}}--cloud-client={{name}}{{/value=cloud}} \
		{{#value=local}}--binding={{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}{{:#metadata.install-dir}}/{{name}}{{/value=local}} \
		{{#value=tcp}}--ws-client=tcp:{{name}}{{/value=tcp}} \
	{{/required-api}} \
	{{#required-binding}} \
		{{#value=local}}--binding={{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}{{:#metadata.install-dir}}/{{name}}{{/value=local}} \
		{{#value=extern}}--binding={{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}{{#required-permission.urn:redpesk:permission::partner:scope-platform}}{{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}/run/platform{{/required-permission.urn:redpesk:permission::partner:scope-platform}}{{^required-permission.urn:redpesk:permission::partner:scope-platform}}{{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}/run/user/%i{{/required-permission.urn:redpesk:permission::partner:scope-platform}}/apis/link/{{name}}{{/value=extern}} \
	{{/required-binding}} \
	{{#provided-api}} \
		{{#value=auto|ws}}--ws-server=sd:{{name}}{{/value=auto|ws}} \
		{{#value=dbus}}--dbus-server={{name}}{{/value=dbus}} \
		{{#value=tcp}}--ws-server=tcp:{{name}}{{/value=tcp}} \
	{{/provided-api}} \
	{{#required-permission.urn:redpesk:permission::platform:apis:auto-ws}}--auto-api={{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}{{#required-permission.urn:redpesk:permission::partner:scope-platform}}{{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}/run/platform{{/required-permission.urn:redpesk:permission::partner:scope-platform}}{{^required-permission.urn:redpesk:permission::partner:scope-platform}}{{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}/run/user/%i{{/required-permission.urn:redpesk:permission::partner:scope-platform}}/apis/ws{{/required-permission.urn:redpesk:permission::platform:apis:auto-ws}} \
	{{#content.type=text/html}}--exec /usr/bin/cynagoauth-launch /usr/bin/web-runtime http://{{#required-permission.urn:redpesk:permission::partner:scope-platform}}localuser---{{:#metatarget.afid}}{{/required-permission.urn:redpesk:permission::partner:scope-platform}}{{^required-permission.urn:redpesk:permission::partner:scope-platform}}localuser--{{:#metatarget.afid}}{{/required-permission.urn:redpesk:permission::partner:scope-platform}}:8080/{{content.src}}{{/content.type=text/html}} \
	{{#content.type=application/vnd.redpesk.native|application/vnd.agl.native}}--exec {{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}{{:#metadata.install-dir}}/{{content.src}} @p @t{{/content.type=application/vnd.redpesk.native|application/vnd.agl.native}}
%nl

{{/content.type=text/html|application/vnd.redpesk.native|application/vnd.agl.native|application/vnd.redpesk.service|application/vnd.agl.service|application/vnd.redpesk.httpd}}

;-------------------------------------------------------------------------------
;----                 application/x-executable                              ----
;-------------------------------------------------------------------------------
{{#content.type=application/x-executable}}
ExecStart={{##metadata.redpak}}/usr/bin/redwrap --redpath {{:#metadata.root-dir}} -- {{/#metadata.redpak}} {{^#metadata.redpak}}{{:#metadata.root-dir}}/{{/#metadata.redpak}}{{:#metadata.install-dir}}/{{content.src}}
{{/content.type=application/x-executable}}

;-------------------------------------------------------------------------------
;----                 application/vnd.redpesk.resource                      ----
;-------------------------------------------------------------------------------
{{#content.type=application/vnd.agl.resource|application/vnd.redpesk.resource}}
Type=oneshot
ExecStart=/bin/true
{{/content.type=application/vnd.agl.resource|application/vnd.redpesk.resource}}

{{#required-permission.urn:redpesk:permission::system:run-by-default}}
;-------------------------------------------------------------------------------
; auto start
;-------------------------------------------------------------------------------
[Install]
{{#required-permission.urn:redpesk:permission::partner:scope-platform}}
WantedBy=multi-user.target
%systemd-unit wanted-by multi-user.target
{{/required-permission.urn:redpesk:permission::partner:scope-platform}}{{^required-permission.urn:redpesk:permission::partner:scope-platform}}
WantedBy=afm-user-session@.target
%systemd-unit wanted-by afm-user-session@.target
{{/required-permission.urn:redpesk:permission::partner:scope-platform}}
{{/required-permission.urn:redpesk:permission::system:run-by-default}}

%end systemd-unit

{{#required-permission.urn:redpesk:permission::partner:scope-platform}}
;-------------------------------------------------------------------------------
;----        F O R E A C H   P R O V I D E D   A P I S           (PLATFORM) ----
;-------------------------------------------------------------------------------
{{#provided-api}}
{{#value=ws|auto}}
;-------------------------------------------------------------------------------
;----        T H E   S E R V I C E   O F   T H E   A P I           (USER)   ----
;-------------------------------------------------------------------------------
%begin systemd-unit

# auto generated by redpesk framework for {{:id}} version {{:version}} target {{:#target}} of {{:idaver}}

%systemd-unit system
%systemd-unit service afm-api-{{name}}@
%systemd-unit wanted-by afm-user-session@.target

[Unit]
Description=Provides api {{name}} for user %i
X-AFM-API-TYPE={{value}}

BindsTo=afm-user-setup@%i.service
After=afm-user-setup@%i.service

Requires=afm-api-{{name}}.socket
After=afm-api-{{name}}.socket

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/bin/true

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/bin/ln -sf /run/platform/apis/ws/{{name}} /run/user/%i/apis/ws/{{name}}

%end systemd-unit

;-------------------------------------------------------------------------------
;----        T H E   S E R V I C E   O F   T H E   A P I       (PLATFORM)   ----
;-------------------------------------------------------------------------------
%begin systemd-unit

# auto generated by redpesk framework for {{:id}} version {{:version}} target {{:#target}} of {{:idaver}}

%systemd-unit system
%systemd-unit service afm-api-{{name}}
%systemd-unit wanted-by multi-user.target

[Unit]
Description=Provides api {{name}} for platform
X-AFM-API-TYPE={{value}}

Requires=afm-system-setup.service
After=afm-system-setup.service

Requires=afm-api-{{name}}.socket
After=afm-api-{{name}}.socket

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/bin/true

%end systemd-unit

;-------------------------------------------------------------------------------
;----        T H E   S O C K E T   O F   T H E   A P I         (PLATFORM)   ----
;-------------------------------------------------------------------------------

%begin systemd-unit

# auto generated by redpesk framework for {{:id}} version {{:version}} target {{:#target}} of {{:idaver}}

%systemd-unit system
%systemd-unit socket afm-api-{{name}}
[Unit]
Description=Provides websocket api {{name}} for platform
Requires=afm-system-setup.service
After=afm-system-setup.service
DefaultDependencies=no

[Socket]
SmackLabel=*
SmackLabelIPIn=System
SmackLabelIPOut=System
SELinuxContextFromNet=true
ListenStream=/run/platform/apis/ws/{{name}}
FileDescriptorName={{name}}
Service=afm-{{#required-permission.urn:redpesk:permission::public:hidden}}service{{/required-permission.urn:redpesk:permission::public:hidden}}{{^required-permission.urn:redpesk:permission::public:hidden}}appli{{/required-permission.urn:redpesk:permission::public:hidden}}-{{:id}}--{{:#target}}.service

%end systemd-unit

{{/value=ws|auto}}
{{/provided-api}}
;-------------------------------------------------------------------------------
{{/required-permission.urn:redpesk:permission::partner:scope-platform}}{{^required-permission.urn:redpesk:permission::partner:scope-platform}}
;-------------------------------------------------------------------------------
;----        F O R E A C H   P R O V I D E D   A P I S           (USER)     ----
;-------------------------------------------------------------------------------
{{#provided-api}}
{{#value=ws|auto}}
;-------------------------------------------------------------------------------
;----        T H E   S E R V I C E   O F   T H E   A P I                    ----
;-------------------------------------------------------------------------------
%begin systemd-unit

# auto generated by redpesk framework for {{:id}} version {{:version}} target {{:#target}} of {{:idaver}}

%systemd-unit system
%systemd-unit service afm-api-{{name}}@
%systemd-unit wanted-by afm-user-session@.target

[Unit]
Description=Provides api {{name}} for user %i
X-AFM-API-TYPE={{value}}

BindsTo=afm-user-setup@%i.service
After=afm-user-setup@%i.service

Requires=afm-api-{{name}}@%i.socket
After=afm-api-{{name}}@%i.socket

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/bin/true

%end systemd-unit

;-------------------------------------------------------------------------------
;----        T H E   S O C K E T   O F   T H E   A P I                      ----
;-------------------------------------------------------------------------------

%begin systemd-unit

# auto generated by redpesk framework for {{:id}} version {{:version}} target {{:#target}} of {{:idaver}}

%systemd-unit system
%systemd-unit socket afm-api-{{name}}@
[Unit]
Description=Provides websocket api {{name}} for user %i
BindsTo=afm-user-setup@%i.service
After=afm-user-setup@%i.service
DefaultDependencies=no

[Socket]
SmackLabel=*
SmackLabelIPIn=System
SmackLabelIPOut=System
SELinuxContextFromNet=true
ListenStream=/run/user/%i/apis/ws/{{name}}
FileDescriptorName={{name}}
Service=afm-{{#required-permission.urn:redpesk:permission::public:hidden}}service{{/required-permission.urn:redpesk:permission::public:hidden}}{{^required-permission.urn:redpesk:permission::public:hidden}}appli{{/required-permission.urn:redpesk:permission::public:hidden}}-{{:id}}--{{:#target}}@%i.service

%end systemd-unit

{{/value=ws|auto}}
{{/provided-api}}
;-------------------------------------------------------------------------------
{{/required-permission.urn:redpesk:permission::partner:scope-platform}}
{{/targets}}
;-------------------------------------------------------------------------------
; End of file afm-unit.conf mode RELEASE
;-------------------------------------------------------------------------------
